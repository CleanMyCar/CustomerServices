<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Services</title>
  <link rel="stylesheet" href="src/assets/css/bootstrap.min.css">
  <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
  <link rel="stylesheet" href="dist/css/intlTelInput.css">
  <link rel="stylesheet" href="src/assets/css/login.css">
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->

  <script src="src/assets/scripts/jquery-2.1.4.min.js"></script>
  <script src="src/assets/scripts/knockout-3.4.0.js"></script>
  <script src="src/assets/scripts/knockout.validations.js"></script>
  <script src="src/assets/scripts/bootstrap.min.js"></script>
  <script src="dist/js/intlTelInput.js"></script>
</head>

<body>
  <div class="">
    <div class="loginBoxDiv">
      <form>
        <div class="header">

          <img src="./src/assets/logo.png" height="50">
          <h2>My Project</h2>
        </div>
        <div class="row buttonsArea">
          <div class="col-sm-6">
            <input type="button" value="Login" class="loginButton" data-bind="click: showLogin" />
          </div>
          <div class="col-sm-6">
            <input type="button" value="Register" class="registerButton" data-bind="click: showRegister" />
          </div>
        </div>

        <div class="loginScreen" style="display: none">

          <input type="text" placeholder="Phone Number/Email"
            data-bind="value: loginUsername, valueUpdate: 'afterkeydown',event: { keypress: LoginOnEnter }" />
          <input type="password" placeholder="Password"
            data-bind="value: loginPassword, valueUpdate: 'afterkeydown',event: { keypress: LoginOnEnter }" />
          <input type="button" value="Login" class="loginButton" data-bind="click: Login" />
          <div data-bind="text: errLoginMsg" class="invalidClient"></div>
        </div>
        <div class="registerScreen" style="display: none">
          <input type="text" placeholder="First Name"
            data-bind="value: firstName, valueUpdate: 'afterkeydown',event: { keypress: LoginOnEnter }" />
          <input type="text" placeholder="Last Name"
            data-bind="value: lastName, valueUpdate: 'afterkeydown',event: { keypress: LoginOnEnter }" />
          <!-- <input type="text" placeholder="Phone Number" data-bind="value: mobileNumber, valueUpdate: 'afterkeydown',event: { keypress: LoginOnEnter }"
          /> -->
          <input id="phone" name="phone" type="tel"
            data-bind="value: mobileNumber, valueUpdate: 'afterkeydown',event: { keypress: LoginOnEnter }" />
          <input type="text" placeholder="Email"
            data-bind="value: email, valueUpdate: 'afterkeydown',event: { keypress: LoginOnEnter }" />
          <input type="password" minlength="8" placeholder="Password (Min 8 Characters)"
            data-bind="value: password, valueUpdate: 'afterkeydown',event: { keypress: LoginOnEnter }" />
          <input type="text" placeholder="Referral Code (Optional)"
            data-bind="value: referralCode, valueUpdate: 'afterkeydown',event: { keypress: LoginOnEnter }" />
          <input type="button" value="Register" class="registerButton" data-bind="click: Register" />
          <div data-bind="text: errRegisterMsg" class="invalidClient"></div>
        </div>
        <div class="footer">
          Footer goes here......
        </div>
      </form>
    </div>
  </div>

  <script type="text/javascript">


    function GetQueryStringParams(sParam) {
      let sPageURL = window.location.search.substring(1);
      let sURLVariables = sPageURL.split('&');
      for (let i = 0; i < sURLVariables.length; i++) {
        let sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0].toLowerCase() === sParam.toLowerCase()) {
          return sParameterName[1];
        }
      }
    }

    let apiUrl = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':1339' : '')


    let viewModel = function () {
      let self = this;

      let APIRootUrl = '/';
      self.showLoading = ko.observable(false);

      self.errLoginMsg = ko.observable('');
      self.errRegisterMsg = ko.observable('');

      self.showMessage = function (errMsg, success) {
        if (errMsg) {
          self.activateMsg(errMsg);
          self.activateMsgCss('alert alert-danger');
        }
        else {
          self.activateMsg(success);
          self.activateMsgCss('alert alert-success');
        }
      };
      // appUrl
      //login fields start
      self.loginUsername = ko.observable('');
      self.loginPassword = ko.observable('')

      self.loginUsername.extend({
        required: { message: 'Phone Number/Email is required', params: true }
      });
      self.loginPassword.extend({
        required: { message: 'Password is required', params: true }
      });

      self.loginerrors = ko.validation.group([self.loginUsername, self.loginPassword]);
      self.LoginOnEnter = function (data, event) {
        var keyCode = (event.which ? event.which : event.keyCode);
        if (keyCode === 13) {
          this.Login();
          return false;
        }
        return true;
      }
      self.Login = function () {

        if (self.loginerrors().length) {
          self.loginerrors.showAllMessages();
          return;
        }
        // appUrl
        self.errLoginMsg('');
        self.showLoading(true);

        //ajax call
        let loginParams = {
          requestParams: {
            'APIReg': "10001",
            'email': self.loginUsername(),
            'password': self.loginPassword(),
          },
          systemParams: {
            'Source': 'Web',
            'SourceId': window.location.hostname
          }
        };
        $.ajax({
          dataType: "json",
          type: 'POST',
          //crossDomain: true,
          contentType: "application/json;charset=utf-8",
          url: apiUrl + '/api', 		// Location of the service
          data: JSON.stringify(loginParams),
          success: function (response) {
            window.localStorage.removeItem('rttoken');
            window.localStorage.removeItem('CName');
            self.showLoading(false);
            console.log(response);
            if (response) {
              if (!response.response.error) {
                if (response.response.length > 0 && response.response[0] && response.response[0].hasOwnProperty("UserId")) {
                  window.localStorage.setItem('rttoken', response.response[0]["token"]);
                  window.location.href = "/index.html";
                }
                else {
                  if (response.response.errno) {
                    self.errLoginMsg("Server Error: " + response.response.errno);
                  }
                  else
                    self.errLoginMsg("Invalid credentials");
                }
              }
              else {
                self.errLoginMsg(response.response.ErrorMessage);
              }
            }
          },
          error: function (d) {
            window.localStorage.removeItem('vwtoken');
            self.showLoading(false);
            console.log(d.responseJSON);
            self.errRegisterMsg(d.responseJSON.ErrorMessage.message);
          },
        });
      };


      self.firstName = ko.observable('');
      self.lastName = ko.observable('')
      self.mobileNumber = ko.observable('');
      self.email = ko.observable('')
      self.password = ko.observable('');
      self.referralCode = ko.observable('')

      self.firstName.extend({
        required: { message: 'First Name is required', params: true }
      });
      self.lastName.extend({
        required: { message: 'Last Name is required', params: true }
      });
      self.mobileNumber.extend({
        required: { message: 'Phone Number is required', params: true },
        pattern: {
          message: 'Invalid phone number.',
          params: /^\D?(\d{3})\D?\D?(\d{3})\D?(\d{4})$/
        }
      });
      self.email.extend({
        required: { message: 'Email is required', params: true },
        email: { message: 'Please enter valid Email', params: true },
      });
      self.password.extend({
        required: { message: 'Password is required', params: true },
        minLength: { params: 8, message: "Password should be minimun 8 characters" }
      });

      self.registerErrors = ko.validation.group([self.firstName, self.lastName, self.mobileNumber, self.email, self.password]);

      self.Register = function () {
        if (self.registerErrors().length) {
          self.registerErrors.showAllMessages();
          return;
        }
        // appUrl
        self.errRegisterMsg('');
        self.showLoading(true);

        let loginParams = {
          requestParams: {
            'APIReg': "10000",
            'firstName': self.firstName(),
            'lastName': self.lastName(),
            'mobileNumber': self.mobileNumber(),
            'email': self.email(),
            'password': self.password(),
            'referralCode': self.referralCode()
          },
          systemParams: {
            'Source': 'Web',
            'SourceId': window.location.hostname
          }
        };
        $.ajax({
          dataType: "json",
          type: 'POST',
          //crossDomain: true,
          contentType: "application/json;charset=utf-8",
          url: apiUrl + '/api', 		// Location of the service
          data: JSON.stringify(loginParams),
          success: function (response) {
            window.localStorage.removeItem('rttoken');
            self.showLoading(false);
            console.log(response);
            if (response) {
              if (!response.response.error) {
                console.log("response for login", response);
                if (response.response.length > 0 && response.response[0]) {
                  self.showLogin();
                }
                else {
                  if (response.response.errno) {
                    self.errLoginMsg("Server Error: " + response.response.errno);
                  }
                  else
                    self.errLoginMsg("Invalid credentials");
                }
              }
              else {
                self.errLoginMsg(response.response.ErrorMessage);
              }

            }
          },
          error: function (d) {
            window.localStorage.removeItem('vwtoken');
            self.showLoading(false);
            console.log(d.responseJSON);
            self.errRegisterMsg(d.responseJSON.ErrorMessage.message);
          },
        });
      };

      self.IsValidCss = function (field) {
        if (!field.isValid() && field.isModified())
          return 'has-error';
        return '';
      };

      self.showLogin = function () {
        $(".loginScreen").show();
        $(".registerScreen").hide();
      }
      self.showRegister = function () {
        $(".registerScreen").show();
        $(".loginScreen").hide();
      }
    }

    ko.extenders.isEmail = function (elm, customMessage) {
      //add some sub-observables to our observable
      elm.hasError = ko.observable();
      elm.message = ko.observable();
      //This is the function to validate the value entered in the text boxes
      function validateEmail(valEntered) {
        var emailPattern = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        //If the value entered is a valid mail id, return fals or return true
        elm.hasError((emailPattern.test(valEntered) === false) ? true : false);
        //If not a valid mail id, return custom message
        elm.message((emailPattern.test(valEntered) === true) ? "" : customMessage);
      }
      //Call the validation function for the initial validation
      validateEmail(elm());
      //Validate the value whenever there is a change in value
      elm.subscribe(validateEmail);
      return elm;
    };

    ko.applyBindings(viewModel);


    var input = document.querySelector("#phone");
    window.intlTelInput(input, {
      // allowDropdown: false,
      // autoHideDialCode: false,
      // autoPlaceholder: "off",
      // dropdownContainer: document.body,
      // excludeCountries: ["us"],
      // formatOnDisplay: false,
      // geoIpLookup: function(callback) {
      //   $.get("http://ipinfo.io", function() {}, "jsonp").always(function(resp) {
      //     var countryCode = (resp && resp.country) ? resp.country : "";
      //     callback(countryCode);
      //   });
      // },
      // hiddenInput: "full_number",
      initialCountry: "in",
      // localizedCountries: { 'de': 'Deutschland' },
      // nationalMode: false,
      // onlyCountries: ['us', 'gb', 'ch', 'ca', 'do'],
      // placeholderNumberType: "MOBILE",
      // preferredCountries: ['cn', 'jp'],
      // separateDialCode: true,
      utilsScript: "dist/js/utils.js",
    });

  </script>
</body>

</html>